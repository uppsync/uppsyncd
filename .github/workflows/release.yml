name: Release & Publish

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  GHCR_IMAGE: ghcr.io/${{ github.repository }}
  DOCKERHUB_IMAGE: docker.io/${{ github.repository }}

permissions:
  contents: write # Required for creating Releases
  packages: write # Required for pushing to GHCR

jobs:
  package:
    name: Package (${{ matrix.asset_name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # --- LINUX (Standard - glibc) ---
          - arch: "amd64"
            runner: "ubuntu-latest"
            bun_target: "bun-linux-x64"
            asset_name: "linux-amd64"
            pack: "fpm"
            pack_formats: "deb rpm"

          - arch: "arm64"
            runner: "ubuntu-latest"
            bun_target: "bun-linux-arm64"
            asset_name: "linux-arm64"
            pack: "fpm"
            pack_formats: "deb rpm"

          # --- LINUX (Alpine - musl) ---
          - arch: "amd64"
            runner: "ubuntu-latest"
            bun_target: "bun-linux-x64-musl"
            asset_name: "linux-amd64-musl"
            pack: "fpm"
            pack_formats: "apk"

          - arch: "arm64"
            runner: "ubuntu-latest"
            bun_target: "bun-linux-arm64-musl"
            asset_name: "linux-arm64-musl"
            pack: "fpm"
            pack_formats: "apk"

          # --- WINDOWS (Windows Runner) ---
          - arch: "amd64"
            runner: "windows-latest"
            bun_target: "bun-windows-x64"
            asset_name: "windows-amd64"
            pack: "msi"

          # --- MACOS (Mac Runner) ---
          - arch: "amd64" # Intel
            runner: "macos-15-intel"
            bun_target: "bun-darwin-x64-baseline"
            asset_name: "darwin-amd64"
            pack: "pkg"

          - arch: "arm64" # Apple Silicon
            runner: "macos-latest"
            bun_target: "bun-darwin-arm64"
            asset_name: "darwin-arm64"
            pack: "pkg"

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup WiX
        if: contains(matrix.pack, 'msi')
        run: dotnet tool install --global wix

      - name: Install Dependencies
        run: bun install

      - name: Build
        env:
          TARGET: ${{ matrix.bun_target }}
          OUTFILE: dist/${{ github.event.repository.name }}-${{ matrix.asset_name }}
        run: bun run build

      - name: Package
        env:
          ARCH: ${{ matrix.arch }}
          VERSION: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '0.0.0-nightly' }}
          OUTFILE: dist/${{ github.event.repository.name }}-${{ matrix.asset_name }}
          PACK_FORMATS: ${{ matrix.pack_formats }}
        run: bun run pack:${{ matrix.pack }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: assets-${{ matrix.asset_name }}
          path: dist/*
          retention-days: 1
          if-no-files-found: ignore

  github-release:
    name: Publish GitHub Release
    needs: [smoke-test, test-msi, test-pkg]
    runs-on: ubuntu-latest

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: assets-*
          path: dist
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: dist/*

  test-msi:
    name: Test MSI Install
    needs: package
    runs-on: windows-latest

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: assets-windows-amd64
          path: dist

      - name: Install MSI
        shell: powershell
        run: msiexec /i dist\uppsyncd-windows-amd64.msi /quiet /norestart

      - name: Verify Version
        shell: powershell
        run: |
          $env:Path = [Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [Environment]::GetEnvironmentVariable("Path","User")
          uppsyncd version

  test-pkg:
    name: Test PKG Install (${{ matrix.arch }})
    needs: package
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: assets-darwin-${{ matrix.arch }}
          path: dist

      - name: Install PKG
        run: sudo installer -pkg dist/uppsyncd-${{ matrix.arch }}.pkg -target /

      - name: Verify Version
        run: uppsyncd version

  smoke-test:
    name: Smoke Test (linux-${{ matrix.arch }})
    needs: package
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    defaults:
      run:
        working-directory: dist

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: assets-linux-${{ matrix.arch }}
          path: dist

      - name: Prepare Binary
        run: |
          mv uppsyncd-linux-${{ matrix.arch }} uppsyncd
          chmod +x uppsyncd

      - name: Verify Version
        run: ./uppsyncd version

      - name: Verify Help
        run: ./uppsyncd --help

      - name: Verify Run
        env:
          UPPSYNC_METRICS: "true"
        run: |
          # Run for 5 seconds to ensure it starts up and collects metrics without crashing
          # "timeout" returns 124 if it kills the process, which is what we want
          timeout 5s ./uppsyncd run || [ $? -eq 124 ]

      - name: Verify Install (Service)
        run: sudo ./uppsyncd install

      - name: Verify Start (Service)
        run: sudo ./uppsyncd start

      - name: Verify Status (Service)
        run: sudo ./uppsyncd status

      - name: Verify Stop (Service)
        run: sudo ./uppsyncd stop

      - name: Verify Uninstall (Service)
        run: sudo ./uppsyncd uninstall

  publish-apt:
    name: Publish APT Repository
    needs: [smoke-test]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: assets-linux-a??64
          path: dist
          merge-multiple: true

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y reprepro

      - name: Setup GPG
        id: setup_gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: bun run setup:gpg

      - name: Build Repository Index
        env:
          CODENAME: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
          GPG_KEY_ID: ${{ steps.setup_gpg.outputs.GPG_KEY_ID }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: bun run repo:deb

      - name: Publish to S3
        env:
          S3_ENDPOINT: ${{ vars.S3_ENDPOINT }}
          S3_BUCKET: ${{ vars.S3_BUCKET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_SUBPATH: ${{ github.event.repository.name }}
        run: bun run publish

  test-apt:
    name: Test APT Install (${{ matrix.arch }})
    needs: publish-apt
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Add Repository Key
        run: |
          curl -fsSL https://pkg.uppsync.com/uppsync.gpg | sudo tee /etc/apt/keyrings/uppsync.gpg > /dev/null

      - name: Add Repository
        env:
          CHANNEL: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
        run: |
          echo "deb [signed-by=/etc/apt/keyrings/uppsync.gpg] https://pkg.uppsync.com/uppsyncd $CHANNEL main" | sudo tee /etc/apt/sources.list.d/uppsyncd.list

      - name: Install Package
        run: |
          sudo apt-get update
          sudo apt-get install -y uppsyncd

      - name: Verify Version
        run: uppsyncd version

  publish-rpm:
    name: Publish RPM Repository
    needs: [smoke-test]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: assets-linux-a??64
          path: dist
          merge-multiple: true

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y createrepo-c rpm

      - name: Setup GPG
        id: setup_gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: bun run setup:gpg

      - name: Build Repository Index
        env:
          CHANNEL: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_OWNER: ${{ github.repository_owner }}
          GPG_KEY_ID: ${{ steps.setup_gpg.outputs.GPG_KEY_ID }}
        run: bun run repo:rpm

      - name: Publish to S3
        env:
          S3_ENDPOINT: ${{ vars.S3_ENDPOINT }}
          S3_BUCKET: ${{ vars.S3_BUCKET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_SUBPATH: ${{ github.event.repository.name }}
        run: bun run publish

  test-rpm:
    name: Test RPM Install (${{ matrix.arch }})
    needs: publish-rpm
    runs-on: ${{ matrix.runner }}
    container: fedora:latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Install Prerequisites
        run: dnf install -y curl

      - name: Add Repository
        run: |
          curl -fsSL https://pkg.uppsync.com/uppsyncd/uppsyncd.repo | tee /etc/yum.repos.d/uppsyncd.repo

      - name: Install Package
        env:
          CHANNEL: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
        run: |
          if [ "$CHANNEL" = "unstable" ]; then
            # Disable stable repo to ensure we test the unstable one
            dnf install -y --disablerepo=uppsyncd --enablerepo=uppsyncd-unstable uppsyncd
          else
            dnf install -y uppsyncd
          fi

      - name: Verify Version
        run: uppsyncd version

  publish-apk:
    name: Publish APK Repository
    needs: [smoke-test]
    runs-on: ubuntu-latest
    container: oven/bun:alpine

    steps:
      - name: Install System Dependencies
        run: apk add --no-cache git tar unzip alpine-sdk openssl

      - uses: actions/checkout@v6

      - name: Install Dependencies
        run: bun install

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: assets-linux-*-musl
          path: dist
          merge-multiple: true

      - name: Build Repository Index
        env:
          CHANNEL: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
          APK_PRIVATE_KEY: ${{ secrets.APK_PRIVATE_KEY }}
        run: bun run repo:apk

      - name: Publish to S3
        env:
          S3_ENDPOINT: ${{ vars.S3_ENDPOINT }}
          S3_BUCKET: ${{ vars.S3_BUCKET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_SUBPATH: ${{ github.event.repository.name }}
        run: bun run publish

  test-apk:
    name: Test APK Install (${{ matrix.arch }})
    needs: publish-apk
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.image }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            image: alpine:latest
          - arch: arm64
            runner: ubuntu-24.04-arm
            image: arm64v8/alpine:latest

    steps:
      - name: Install Prerequisites
        run: apk add --no-cache curl

      - name: Add Repository Key
        run: |
          curl -fsSL https://pkg.uppsync.com/uppsync.rsa.pub -o /etc/apk/keys/uppsync.rsa.pub

      - name: Add Repository
        env:
          CHANNEL: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
        run: |
          echo "https://pkg.uppsync.com/uppsyncd/alpine/$CHANNEL" >> /etc/apk/repositories

      - name: Install Package
        run: |
          apk update
          apk add uppsyncd

      - name: Verify Version
        run: uppsyncd version

  publish-install-script:
    name: Publish install.sh
    needs: [test-apt, test-rpm, test-apk]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Prepare Script
        run: |
          mkdir -p repo
          cp scripts/install.sh repo/install.sh

      - name: Publish to S3
        env:
          S3_ENDPOINT: ${{ vars.S3_ENDPOINT }}
          S3_BUCKET: ${{ vars.S3_BUCKET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_SUBPATH: ${{ github.event.repository.name }}
        run: bun run publish

  test-install-script:
    name: Test install.sh (${{ matrix.distro }}-${{ matrix.arch }})
    needs: publish-install-script
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.image }}
    strategy:
      fail-fast: false
      matrix:
        distro: [ubuntu, fedora, alpine]
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
          - distro: ubuntu
            image: ubuntu:latest
          - distro: fedora
            image: fedora:latest
          - distro: alpine
            arch: amd64
            image: alpine:latest
          - distro: alpine
            arch: arm64
            image: arm64v8/alpine:latest

    steps:
      - name: Install Prerequisites
        run: |
          if command -v apt-get > /dev/null; then
            apt-get update && apt-get install -y curl
          elif command -v dnf > /dev/null; then
            dnf install -y curl
          elif command -v apk > /dev/null; then
            apk add --no-cache curl
          fi

      - name: Run Install Script
        env:
          CHANNEL: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'unstable' }}
        run: |
          curl -fsSL https://pkg.uppsync.com/uppsyncd/install.sh | sh -s -- --channel=$CHANNEL

      - name: Verify Version
        run: uppsyncd version

  docker-build:
    name: Docker Build (${{ matrix.arch }})
    needs: [smoke-test]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    steps:
      - uses: actions/checkout@v6

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: assets-linux-${{ matrix.arch }}
          path: dist

      - name: Prepare Context
        id: context
        run: |
          # Move binary to expected structure (linux/amd64/uppsyncd)
          mkdir -p ${{ matrix.platform }}
          mv dist/uppsyncd-linux-${{ matrix.arch }} ${{ matrix.platform }}/uppsyncd

          platform=${{ matrix.platform }}
          echo "platform_pair=${platform//\//-}" >> $GITHUB_OUTPUT

      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.GHCR_IMAGE }}
            ${{ env.DOCKERHUB_IMAGE }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push (Digest)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.GHCR_IMAGE }},push-by-digest=true,name-canonical=true,push=true

      - name: Export Digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"

      - name: Upload Digest
        uses: actions/upload-artifact@v6
        with:
          name: digests-${{ steps.context.outputs.platform_pair }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  docker-merge:
    name: Publish Docker
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Download Digests
        uses: actions/download-artifact@v7
        with:
          pattern: digests-*
          path: ${{ runner.temp }}/digests
          merge-multiple: true

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.GHCR_IMAGE }}
            ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}

      - name: Create Manifest List and Push
        working-directory: ${{ runner.temp }}/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.GHCR_IMAGE }}@sha256:%s ' *)

      - name: Inspect Image
        run: |
          echo "Inspecting GHCR image..."
          docker buildx imagetools inspect ${{ env.GHCR_IMAGE }}:${{ steps.meta.outputs.version }}
          echo "Inspecting Docker Hub image..."
          docker buildx imagetools inspect ${{ env.DOCKERHUB_IMAGE }}:${{ steps.meta.outputs.version }}

  test-docker:
    name: Test ${{ matrix.registry }} Image (${{ matrix.arch }})
    needs: docker-merge
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            registry: ghcr.io
          - arch: arm64
            runner: ubuntu-24.04-arm
            registry: ghcr.io
          - arch: amd64
            runner: ubuntu-latest
            registry: docker.io
          - arch: arm64
            runner: ubuntu-24.04-arm
            registry: docker.io

    steps:
      - name: Login to GHCR
        if: matrix.registry == 'ghcr.io'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: matrix.registry == 'docker.io'
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine Image
        id: get_image
        run: |
          # Determine tag: 'latest' for releases, branch name (e.g. 'main') for others
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            TAG="latest"
          else
            TAG="${{ github.ref_name }}"
            TAG=${TAG//\//-}
          fi

          if [[ "${{ matrix.registry }}" == "ghcr.io" ]]; then
            IMAGE="${{ env.GHCR_IMAGE }}:$TAG"
          else
            IMAGE="${{ env.DOCKERHUB_IMAGE }}:$TAG"
          fi

          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Pull Image
        run: docker pull ${{ steps.get_image.outputs.image }}

      - name: Verify Version
        run: docker run --rm ${{ steps.get_image.outputs.image }} version
